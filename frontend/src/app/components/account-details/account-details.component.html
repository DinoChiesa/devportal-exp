<app-navbar></app-navbar>

<!-- Confirmation Modal -->
<div *ngIf="showConfirmationModal" class="modal-overlay">
  <div class="modal-content confirmation-modal">
    <h4>Generate Credentials for Mutual TLS</h4>
    <p>
      For a subset of our APIs, you must use mutual TLS to connect with us,
      according to the approach described in
      <a
        href="https://datatracker.ietf.org/doc/html/rfc8705#name-mutual-tls-for-oauth-client"
        >IETF RFC 8705</a
      >. For this, your client-side application must have a private key, and a
      valid matching x509 certificate containing the corresponding public key,
      and that certificate must be signed by a Certificate Authority that we
      trust.
    </p>

    <p>
      This web page allows you to generate a key pair and certificate, suitable
      for securing your connection to our APIs that require mutual TLS. It will
      generate the keypair locally, and send the public key to us. We will
      generate a signed x509 certificate wrapping the public key, and associate
      it to your partner account. Then this web page will save the private key
      and the certificate to your local machine. You will need to configure your
      applications to use this private key and certificate in the TLS handshake.
    </p>

    <ul>
      <li>
        The private key will be generated within your browser via the
        <a href="https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto"
          >SubtleCrypto facility</a
        >, and this web page does not share the private key with us. It will
        save the private key to your local machine, wrapped in a zip archive.
        The private key is yours; you should not disclose or share it.
      </li>
      <li>
        The certificate is generated by us, specifically for the purpose of
        facilitating mutual-TLS authentication for our APIs. It is also yours.
        The certificate is not a secret.
      </li>
    </ul>

    <p>
      The security of the key, and the integrity of the subsequent connection
      with us, depends on several factors:
    </p>
    <ol>
      <li>
        Your local machine has not been compromised and does not harbor malware.
      </li>
      <li>Your web browser is up to date.</li>
      <li>
        You trust this website; it is served from a domain you trust, uses
        HTTPS, and the browser address bar indicates that the website is
        trusted.
      </li>
      <li>
        You will be able to assure physical security of the zip file, after the
        key is saved. Store it securely, don't send it in email, etc.
      </li>
    </ol>

    <p>
      You should proceed only if you <strong>acknowledge the above.</strong>
    </p>

    <div class="modal-actions">
      <button
        class="button-primary"
        (click)="startCertificateGenerationProcess()"
      >
        Acknowledge &amp; Proceed
      </button>
      <button class="button-secondary" (click)="cancelCertificateGeneration()">
        Cancel
      </button>
    </div>
  </div>
</div>
<!-- End Confirmation Modal -->

<!-- Certificate Generation Progress Modal -->
<div *ngIf="isGeneratingCertificate" class="modal-overlay">
  <div class="modal-content progress-modal">
    <h4>Generating a New Certificate &amp; Key</h4>
    <ul class="status-list">
      <li *ngFor="let status of certificateGenerationStatus">{{ status }}</li>
    </ul>
    <!-- Simple visual cue -->
    <div class="modal-activity-indicator">Working...</div>
  </div>
</div>
<!-- End Certificate Generation Modal -->

<div class="account-container">
  <h1>Account Details</h1>

  <div *ngIf="isLoading && !isGeneratingCertificate" class="info-message">
    Loading account details...
  </div>

  <div *ngIf="errorLoading && !isLoading" class="info-message error-message">
    Error: Could not load account details.
  </div>

  <div *ngIf="!isLoading && !errorLoading">
    <div *ngIf="details; else noDetails" class="details-grid">
      <div class="detail-item">
        <span class="detail-label">Email:</span>
        <span class="detail-value">{{ details.email }}</span>
      </div>
      <div class="detail-item" *ngIf="details.firstName">
        <span class="detail-label">First Name:</span>
        <span class="detail-value">{{ details.firstName }}</span>
      </div>
      <div class="detail-item" *ngIf="details.lastName">
        <span class="detail-label">Last Name:</span>
        <span class="detail-value">{{ details.lastName }}</span>
      </div>
      <div class="detail-item" *ngIf="details.userName">
        <span class="detail-label">Username:</span>
        <span class="detail-value">{{ details.userName }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-label">Developer ID:</span>
        <span class="detail-value"><code>{{ details.developerId }}</code></span>
      </div>
      <div class="detail-item" *ngIf="details.status">
        <span class="detail-label">Status:</span>
        <span class="detail-value">{{ details.status }}</span>
      </div>
      <div class="detail-item" *ngIf="details.createdAt">
        <span class="detail-label">Created At:</span>
        <span class="detail-value">{{ formatDate(details.createdAt) }}</span>
      </div>
      <!-- Removed Last Modified display -->

      <!-- Attributes Section -->
      <div
        class="attributes-section"
        *ngIf="details.attribute && details.attribute.length > 0"
      >
        <h3>Attributes</h3>
        <ul class="attribute-list">
          <ng-container *ngFor="let attr of details.attribute">
            <li
              *ngIf="
                !attr.name.startsWith('cert-') && !attr.name.endsWith('-pem')
              "
            >
              <span class="attr-name">{{ attr.name }}:</span>
              <span class="attr-value">{{ attr.value }}</span>
            </li>
          </ng-container>
        </ul>
      </div>
      <div
        class="attributes-section"
        *ngIf="!details.attribute || details.attribute.length === 0"
      >
        <h3>Attributes</h3>
        <p>No custom attributes found.</p>
      </div>

      <!-- Certificates Section -->
      <div class="certificates-section">
        <div class="section-header">
          <h3>Certificates</h3>
          <!-- Certificate Action Menu -->
          <div class="cert-menu-container">
            <button
              class="hamburger-button cert-action-button"
              (click)="toggleCertMenu()"
              [disabled]="isLoading || isGeneratingCertificate || showConfirmationModal || !details || (details.certificates && details.certificates.length >= 4)"
              title="{{ (details.certificates && details.certificates.length >= 4) ? 'Maximum number of certificates reached' : 'Certificate Actions' }}"
            >
              &#9776;
              <!-- Hamburger icon -->
            </button>
            <div
              class="dropdown-menu cert-dropdown"
              [class.show]="showCertMenu"
            >
              <a class="dropdown-item" (click)="requestCertificateGeneration()"
                >Generate New Credentials</a
              >
              <a class="dropdown-item" (click)="requestCertificateUpload()"
                >Upload Existing Certificate</a
              >
            </div>
          </div>
          <!-- End Certificate Action Menu -->
        </div>
        <p *ngIf="!details?.certificates?.length">
          No certificates registered.
        </p>
        <ul class="certificate-list" *ngIf="details?.certificates?.length">
          <li
            *ngFor="let cert of details.certificates"
            [class.deleting]="deletingCerts.has(cert.id)"
          >
            <span class="cert-id">{{ cert.id }}:</span>
            <span class="cert-fingerprint"
              ><code>{{ cert.fingerprint }}</code></span
            >
            <button
              class="button-delete"
              (click)="deleteCertificate(cert.id)"
              title="Delete Certificate {{cert.id}}"
              [disabled]="deletingCerts.has(cert.id)"
            >
              тип
            </button>
          </li>
        </ul>
      </div>
    </div>
    <ng-template #noDetails>
      <p class="info-message">Account details not found.</p>
    </ng-template>
  </div>
</div>

<!-- Upload Certificate Modal -->
<div *ngIf="showUploadModal" class="modal-overlay">
  <div class="modal-content upload-modal">
    <h4>Upload your own x509 Certificate</h4>
    <p>Requirements:</p>
    <ul>
      <li>
        The certificate must use a modern RSA of bit strength 2048 or higher, or
        an ECDSA key, with key length 256 bits or higher .
      </li>
      <li>The Basic Constraints extension must not contain CA=true.</li>
      <li>The certificate must not be expired.</li>
      <li>The Extended Key Usage extension must contain clientAuth.</li>
      <li>
        The Extended Key Usage extension must not contain the codeSigning,
        timeStamping, or OCSPSigning fields.
      </li>
      <li>The signature digest algorithm must be SHA256 or stronger.</li>
      <li>It must not be self-signed.</li>
    </ul>
    <p>
      Select a certificate file (.pem or .cer) to upload and register with your
      account.
    </p>

    <div class="form-group file-upload-group">
      <!-- Hidden File Input -->
      <input
        type="file"
        id="certFile"
        #fileInput
        (change)="onFileSelected($event)"
        accept=".pem,.cer"
        [disabled]="isUploading"
        class="visually-hidden"
      />

      <!-- Proxy Button -->
      <button
        type="button"
        class="button-secondary choose-file-button"
        (click)="fileInput.click()"
        [disabled]="isUploading"
      >
        Choose File...
      </button>

      <!-- File Name Display -->
      <span *ngIf="selectedFile" class="file-name"
        >{{ selectedFile.name }}</span
      >
      <span *ngIf="!selectedFile && !isUploading" class="file-name placeholder"
        >No file selected</span
      >
    </div>

    <div *ngIf="uploadError" class="error-message upload-error-msg">
      <span>{{ uploadError }}</span>
      <button
        class="dismiss-error-button"
        (click)="uploadError = null"
        title="Dismiss error"
      >
        ├Ч
      </button>
    </div>

    <div class="modal-actions">
      <button
        class="button-primary"
        (click)="uploadSelectedCertificate()"
        [disabled]="!selectedFile || isUploading"
      >
        {{ isUploading ? 'Uploading...' : 'Upload' }}
      </button>
      <button
        class="button-secondary"
        (click)="cancelUpload()"
        [disabled]="isUploading"
      >
        Cancel
      </button>
    </div>
  </div>
</div>
<!-- End Upload Certificate Modal -->
